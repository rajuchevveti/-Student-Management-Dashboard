{% extends "base.html" %}

{% block title %}Robotics Academy - All Assignments{% endblock %}

{% block page_title %}All Assignments{% endblock %}

{% block page_subtitle %}Manage assignments across all classes{% endblock %}

{% block content %}
<!-- Header Actions -->
<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 gap-4">
    <!-- Filter Section (Left) -->
    <div class="flex flex-col sm:flex-row gap-3">
        <div class="relative">
            <i class="fas fa-search text-gray-400 absolute top-1/2 left-3 transform -translate-y-1/2"></i>
            <input type="text" id="searchAssignments" placeholder="Search assignments..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 w-full sm:w-48">
        </div>
        <!-- Ensure all_classes is passed from app.py -->
        <select id="classFilter" class="p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 w-full sm:w-auto">
            <option value="all">All Classes</option>
            {% for cls in all_classes | sort(attribute='name') %}
            {# Display campus alongside class name and section #}
            <option value="{{ cls.id }}">{{ cls.name }} - {{ cls.section }} ({{ cls.campus }})</option>
            {% endfor %}
        </select>
        <!-- Ensure assignment_types is passed from app.py -->
        <select id="typeFilter" class="p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 w-full sm:w-auto">
            <option value="all">All Types</option>
            {% for type_option in assignment_types %}
            <option value="{{ type_option }}">{{ type_option }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Action Buttons (Right) -->
    <div class="flex space-x-3 w-full md:w-auto justify-end">
        <button onclick="window.location.href='{{ url_for('dashboard') }}'"
                class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors text-sm font-medium flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>Back
        </button>
        <!-- This button requires the addAssignmentModal to be defined (usually in base.html) -->
        <button onclick="showAddAssignmentModal()"
                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm font-medium flex items-center">
            <i class="fas fa-plus mr-2"></i>New Assignment
        </button>
    </div>
</div>

<!-- Assignments Grid -->
<!-- This version assumes app.py prepares assignments with `classNames` and `classColors` lists -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 assignments-grid">
    {% for assignment in assignments %}
    <div class="bg-white rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition-shadow duration-200 p-5 assignment-row assignment-card"
         data-type="{{ assignment.type | lower }}"
         data-title="{{ assignment.title | lower }}"
         data-class-ids="{{ assignment.classIds | join(',') if assignment.classIds else '' }}" {# Use classIds if available #}
         data-class-names="{{ (assignment.classNames | join(',')) | lower if assignment.classNames else '' }}">

        <div class="flex justify-between items-start mb-3">
            <div>
                <h3 class="text-md font-semibold text-gray-800 leading-tight">{{ assignment.title | default('Untitled Assignment') }}</h3>

                <!-- Show list of class tags -->
                <div class="flex flex-wrap gap-1 mt-2">
                {% if assignment.classNames and assignment.classNames|length > 0 %}
                    {% for i in range(assignment.classNames | length) %}
                        <span class="text-xs font-medium px-2 py-0.5 rounded-full text-white {{ assignment.classColors[i] | default('bg-gray-500') }}">
                            {{ assignment.classNames[i] | default('Unknown Class') }}
                        </span>
                    {% endfor %}
                {% else %}
                    <span class="text-xs text-gray-400 italic">No classes assigned</span>
                {% endif %}
                </div>
            </div>

            <!-- Dropdown Menu -->
            <div class="relative">
                 {% if assignment.id %} {# Check if ID exists before rendering button #}
                <button class="text-gray-400 hover:text-gray-600 focus:outline-none w-6 h-6 flex items-center justify-center rounded" onclick="toggleDropdown('{{ assignment.id }}')">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div id="dropdown-{{ assignment.id }}" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10" role="menu">
                    <div class="py-1" role="none">
                        {# Check if classIds exist and is not empty #}
                        {% if assignment.classIds and assignment.classIds | length > 0 %}
                            <p class="text-xs text-gray-500 px-4 pt-2 pb-1 font-semibold uppercase">View/Edit Grades For:</p>
                            {# Loop through classIds and corresponding names to generate links #}
                            {% for i in range(assignment.classIds | length) %}
                            <a href="{{ url_for('gradebook', assignment_id=assignment.id, class_id=assignment.classIds[i]) }}" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">
                                <i class="fas fa-users w-4 mr-2 text-gray-400"></i>{# Ensure classNames[i] exists #}{{ assignment.classNames[i] | default('Class ' + assignment.classIds[i]) }}
                            </a>
                            {% endfor %}
                        {% else %}
                             {# Link to gradebook with just assignment_id if no classes #}
                             <a href="{{ url_for('gradebook', assignment_id=assignment.id) }}" class="text-gray-400 block px-4 py-2 text-sm italic" role="menuitem">No classes assigned</a>
                        {% endif %}
                        <div class="border-t my-1"></div>
                        <a href="#" onclick="editAssignment('{{ assignment.id }}'); return false;" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">
                            <i class="fas fa-pen w-4 mr-2 text-gray-400"></i>Edit Details
                        </a>
                        <a href="#" onclick="deleteAssignment('{{ assignment.id }}'); return false;" class="text-red-600 block px-4 py-2 text-sm hover:bg-red-50" role="menuitem">
                            <i class="fas fa-trash-alt w-4 mr-2 text-red-400"></i>Delete Assignment
                        </a>
                    </div>
                </div>
                 {% else %}
                 {# Optionally show an error or placeholder if assignment ID is missing #}
                 <span class="text-red-500 text-xs italic">(Error: Missing ID)</span>
                {% endif %}
            </div>

        </div>

        <div class="flex items-center space-x-4 text-xs text-gray-500 mb-4">
            <span class="flex items-center" title="Due Date">
                <i class="far fa-calendar-alt mr-1.5"></i>
                Due: {{ assignment.dueDate | default('N/A') }}
            </span>
            <span class="flex items-center" title="Total Points">
                <i class="fas fa-star mr-1.5"></i>
                {{ assignment.totalPoints | default('N/A') }} pts
            </span>
            <span class="px-2 py-0.5 bg-gray-100 text-gray-700 rounded-full text-xs font-medium">
                {{ assignment.type | default('Unknown') }}
            </span>
        </div>

        <!-- Assignment Progress/Stats -->
        <div>
            <div class="flex justify-between text-xs text-gray-500 mb-1">
                <span>Avg. Grade {% if assignment.gradedCount > 0 %}({{ assignment.gradedCount }} graded){% endif %}</span>
                <span class="font-medium text-gray-700">
                    {% if assignment.averageGrade is not none %}
                        {{ assignment.averageGrade }}%
                    {% else %}
                        Not Graded
                    {% endif %}
                </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-1.5">
                <div class="bg-blue-500 h-1.5 rounded-full"
                     style="width: {% if assignment.averageGrade is not none %}{{ assignment.averageGrade }}%{% else %}0%{% endif %}"></div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="md:col-span-2 lg:col-span-3 text-center py-16 bg-white rounded-xl shadow-md border border-gray-100">
        <i class="fas fa-clipboard-list text-gray-300 text-5xl mb-4"></i>
        <p class="text-gray-500 text-lg mb-4">No assignments created yet.</p>
        <button onclick="showAddAssignmentModal()"
                class="bg-green-600 text-white px-5 py-2.5 rounded-lg hover:bg-green-700 transition-colors text-sm font-medium inline-flex items-center">
            <i class="fas fa-plus mr-2"></i>Create First Assignment
        </button>
    </div>
    {% endfor %}
</div>

{% endblock %}

{% block scripts %}
{# No page-specific scripts needed beyond script.js #}
{% endblock %}

