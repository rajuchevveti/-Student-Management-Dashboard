{% extends "base.html" %}

{% block title %}Robotics Academy - Attendance - {{ class_data.name }}{% endblock %}

{% block page_title %}Attendance - {{ class_data.section }}{% endblock %}

{% block page_subtitle %}Track and manage student attendance{% endblock %}

{% block content %}
<!-- Header Actions -->
<div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8">
    <div>
        <span class="text-sm font-medium px-3 py-1 rounded-full text-white {{ class_data.color }}">
            {{ class_data.name }}
        </span>
    </div>
    <div class="flex space-x-4 mt-4 lg:mt-0">
        <button onclick="window.location.href='/class/{{ class_data.id }}'" 
                class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Back to Class
        </button>
        <button onclick="addNewDate()" 
                class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
            <i class="fas fa-plus mr-2"></i>New Date
        </button>
    </div>
</div>

<!-- Attendance Table -->
<div class="bg-white rounded-xl shadow-lg overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-4 text-left font-semibold text-gray-700">Student Name</th>
                    {% for date in dates %}
                    <th class="px-4 py-4 text-center font-semibold text-gray-700 text-sm">
                        {{ date }}<br>
                        <span class="text-xs font-normal text-gray-500">{{ date }}</span>
                    </th>
                    {% endfor %}
                    <th class="px-6 py-4 text-center font-semibold text-gray-700">Attendance Rate</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for student in students %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <i class="fas fa-user-circle text-gray-400 text-xl mr-3"></i>
                            <span class="font-medium text-gray-900">{{ student.name }}</span>
                        </div>
                    </td>
                    {% for date in dates %}
                    <td class="px-4 py-4 text-center">
                        {% set student_attendance = attendance[date].get(student.id, 'not-recorded') %}
                        <select class="attendance-select border rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                data-student-id="{{ student.id }}"
                                data-date="{{ date }}"
                                onchange="updateAttendance('{{ student.id }}', '{{ date }}', this.value)">
                            <option value="not-recorded" {% if student_attendance == 'not-recorded' %}selected{% endif %}>-</option>
                            <option value="present" {% if student_attendance == 'present' %}selected{% endif %}>Present</option>
                            <option value="absent" {% if student_attendance == 'absent' %}selected{% endif %}>Absent</option>
                            <option value="late" {% if student_attendance == 'late' %}selected{% endif %}>Late</option>
                            <option value="excused" {% if student_attendance == 'excused' %}selected{% endif %}>Excused</option>
                        </select>
                    </td>
                    {% endfor %}
                    <td class="px-6 py-4 text-center">
                        <span class="px-3 py-1 rounded-full text-sm font-medium 
                                    {% if student.attendanceRate >= 90 %}bg-green-100 text-green-800
                                    {% elif student.attendanceRate >= 80 %}bg-blue-100 text-blue-800
                                    {% elif student.attendanceRate >= 70 %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-red-100 text-red-800{% endif %}">
                            {{ student.attendanceRate }}%
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Attendance Summary -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-6">
    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
        <div class="text-2xl font-bold text-green-600">{{ dates|length }}</div>
        <div class="text-sm text-gray-600">Class Days</div>
    </div>
    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
        <div class="text-2xl font-bold text-blue-600">{{ students|length }}</div>
        <div class="text-sm text-gray-600">Students</div>
    </div>
    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
        <div class="text-2xl font-bold text-purple-600">
            {% set total_rate = students|sum(attribute='attendanceRate') %}
            {% if students %}{{ (total_rate / students|length)|round }}{% else %}0{% endif %}%
        </div>
        <div class="text-sm text-gray-600">Average Attendance</div>
    </div>
    <div class="bg-white rounded-xl shadow-lg p-6 text-center">
        <div class="text-2xl font-bold text-red-600">
            {% set low_attendance = students|selectattr('attendanceRate', 'lt', 70)|list %}
            {{ low_attendance|length }}
        </div>
        <div class="text-sm text-gray-600">Low Attendance</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function updateAttendance(studentId, date, status) {
    try {
        const response = await fetch('/update_attendance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                class_id: '{{ class_data.id }}',
                date: date,
                student_id: studentId,
                status: status
            })
        });
        
        const result = await response.json();
        if (result.success) {
            // Show success feedback
            const select = event.target;
            select.classList.add('bg-green-100');
            setTimeout(() => {
                select.classList.remove('bg-green-100');
                location.reload(); // Reload to update attendance rates
            }, 1000);
        }
    } catch (error) {
        console.error('Error updating attendance:', error);
        alert('Error updating attendance');
    }
}

function addNewDate() {
    const today = new Date().toISOString().split('T')[0];
    const date = prompt('Enter date (YYYY-MM-DD):', today);
    
    if (date) {
        // Add the new date to the table
        // This would require server-side implementation
        alert(`New date ${date} will be added. Refresh the page to see it.`);
    }
}
</script>
{% endblock %}